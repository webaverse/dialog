<!doctype html>
<html>

<head>
</head>

<body>
<script type=module>
import RoomClient from './client/RoomClient.js';
import bowser from'./bowser/src/bowser.js';

function deviceInfo() {
  const ua = navigator.userAgent;
  const browser = bowser.getParser(ua);
  let flag;

  if (browser.satisfies({ chrome: '>=0', chromium: '>=0' }))
    flag = 'chrome';
  else if (browser.satisfies({ firefox: '>=0' }))
    flag = 'firefox';
  else if (browser.satisfies({ safari: '>=0' }))
    flag = 'safari';
  else if (browser.satisfies({ opera: '>=0' }))
    flag = 'opera';
  else if (browser.satisfies({ 'microsoft edge': '>=0' }))
    flag = 'edge';
  else
    flag = 'unknown';

  return {
    flag,
    name    : browser.getBrowserName(),
    version : browser.getBrowserVersion()
  };
}
function randomName() {
  return Math.random().toString(36).substring(7);
}

(async () => {

window.logger = console; // new Logger('RoomClient');
// window.logger.debug = window.logger.info;

const roomId = 'room1';
const peerId = randomName();
const displayName = randomName();
// Get current device info.
const device = deviceInfo();

/* store.dispatch(
	stateActions.setRoomUrl(roomUrl));

store.dispatch(
	stateActions.setRoomFaceDetection(faceDetection));

store.dispatch(
	stateActions.setMe({ peerId, displayName, displayNameSet, device })); */

const roomClient = new RoomClient({
	roomId,
	peerId,
	displayName,
	device,
  produce: true,
  consume: true,
  datachannel: true,
	/* handlerName : handler,
	useSimulcast,
	useSharingSimulcast,
	forceTcp,
	produce,
	consume,
	forceH264,
	forceVP9,
	svc,
	datachannel,
	externalVideo */
});
roomClient.addEventListener('addsend', async e => {
  const {data: {dataProducer: {id, _dataChannel}}} = e;
  console.log('add send', id, _dataChannel, _dataChannel.readyState);
  if (_dataChannel.readyState !== 'open') {
    await new Promise((accept, reject) => {
      const _open = e => {
        accept();

        // _dataChannel.flushMessageQueue();
        _dataChannel.removeEventListener('open', _open);
      };
      _dataChannel.addEventListener('open', _open);
    });
  }
  /* _dataChannel.addEventListener('open', e => {
    console.log('send open', e); */
    // setInterval(() => {
  console.log('sending...');
      _dataChannel.send('lol');
    // }, 1000);
  // });
});
roomClient.addEventListener('removesend', e => {
  const {data: {dataProducer: {id, _dataChannel}}} = e;
  console.log('remove send', id, _dataChannel);
});
roomClient.addEventListener('addreceive', e => {
  const {data: {dataConsumer: {id, _dataChannel}}} = e;
  console.log('add data consumer', id, _dataChannel);
  _dataChannel.addEventListener('message', e => {
    console.log('got data message', e);
  });
});
roomClient.addEventListener('removereceive', e => {
  const {data: {dataConsumer: {id, _dataChannel}}} = e;
  console.log('add data consumer', id, _dataChannel);
});
/* roomClient.addEventListener('message', e => {
  console.log('message', e);
}); */
roomClient.addEventListener('addreceivestream', e => {
  const {data: {consumer: {id, _track}}} = e;
  console.log('add receive stream', id, _track);
});
roomClient.addEventListener('removereceivestream', e => {
  const {data: {consumer: {id, _track}}} = e;
  console.log('remove receive stream', id, _track);
});

roomClient.join();
roomClient.addEventListener('join', async e => {
  console.log('got join');
  roomClient.enableChatDataProducer();
  // await roomClient.enableMic();
  // await roomClient.enableWebcam();
});

})();
</script>
</body>

</html>